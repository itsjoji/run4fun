<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>run4fun</title>

<style>
  :root {
    --bg-color: #4b8ce6;
    --font-main: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --font-display: "Georgia", serif;
    --font-mono: monospace;
    --font-impact: "Impact", sans-serif;

    /* Rarity Colors */
    --r-common: #b0b0b0;    
    --r-uncommon: #2ecc71;  
    --r-rare: #00d4ff;      
    --r-epic: #bd00ff;      
    --r-legendary: #f39c12; 
    --r-mythic: #f1c40f;    
  }

  html, body {
    margin: 0; height: 100%; background: var(--bg-color);
    overflow: hidden; font-family: var(--font-main);
    touch-action: none; user-select: none; -webkit-user-select: none;
  }

  #game { display: block; width: 100vw; height: 100vh; image-rendering: pixelated; }

  /* --- UI OVERLAYS --- */
  .ui-layer {
    position: absolute; pointer-events: none; color: white;
    font-weight: bold; text-shadow: 2px 2px 0 #000; z-index: 10;
  }

  /* HUD CONTAINER */
  #hud-container {
    position: absolute; top: 20px; left: 20px;
    display: flex; align-items: center; gap: 15px;
    z-index: 10; pointer-events: none;
  }

  #hud-stats {
    display: flex; flex-direction: column; gap: 5px;
  }

  #hud-score { 
    font-size: 24px; font-family: var(--font-mono);
    background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 4px;
  }
  
  #hud-stars { 
    color: #ffd700; font-size: 20px; font-family: var(--font-mono);
    background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 4px;
  }

  #clock-canvas {
    width: 64px; height: 64px;
    border-radius: 50%;
    border: 4px solid #333;
    background: #000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    image-rendering: pixelated;
  }

  #overlay-center {
    left: 50%; top: 50%; transform: translate(-50%, -50%);
    font-size: 30px; text-align: center; width: 100%;
    transition: opacity 0.3s ease;
  }

  /* --- MULTIPLIER --- */
  #multiplier-container {
    position: absolute; top: 100px; left: 50%;
    transform: translateX(-50%) scale(0.8);
    font-family: var(--font-impact); text-transform: uppercase;
    color: #ffd700; opacity: 0; pointer-events: none; z-index: 12;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex; flex-direction: column; align-items: center;
  }
  #multiplier-container.active { opacity: 1; transform: translateX(-50%) scale(1); }
  
  #multiplier-text {
    font-size: 50px; font-weight: 900; -webkit-text-stroke: 2px black;
    animation: rainbow 0.5s linear infinite;
  }
  #multiplier-timer {
    font-size: 40px; color: #fff; font-family: var(--font-mono);
    text-shadow: 2px 2px 0 #000; margin-top: 5px;
  }

  @keyframes rainbow {
    0% { text-shadow: 0 0 15px #ff0000; } 20% { text-shadow: 0 0 15px #ffff00; }
    40% { text-shadow: 0 0 15px #00ff00; } 60% { text-shadow: 0 0 15px #00ffff; }
    80% { text-shadow: 0 0 15px #0000ff; } 100% { text-shadow: 0 0 15px #ff00ff; }
  }

  /* --- SHOP BUTTON --- */
  #shop-btn-wrap {
    position: absolute; top: 20px; right: 20px; z-index: 50;
    cursor: pointer; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5));
    transition: transform 0.1s;
  }
  #shop-btn-wrap:active { transform: scale(0.95); }
  
  #shop-btn {
    position: relative; background: #000; color: #fff; border: none;
    font-family: var(--font-impact); font-size: 36px; padding: 15px 35px;
    text-transform: uppercase; letter-spacing: 2px; overflow: hidden;
    display: flex; align-items: center; gap: 15px; transform: skewX(-5deg);
  }
  #shop-btn::before {
    content: ''; position: absolute; top: 50%; left: 50%;
    width: 350px; height: 350px; border-radius: 50%;
    background: conic-gradient(#ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000);
    animation: spin 2.5s linear infinite; z-index: 0;
    transform: translate(-50%, -50%);
  }
  #shop-btn::after { content: ''; position: absolute; inset: 6px; background: #000; z-index: 0; }
  #shop-btn > * { position: relative; z-index: 1; transform: skewX(5deg); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
  
  .star-icon { color: #ffff00; animation: pulse 0.5s infinite alternate; }
  @keyframes spin { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }
  @keyframes pulse { from { transform: skewX(5deg) scale(1); } to { transform: skewX(5deg) scale(1.3); } }

  /* --- SHOP MODAL --- */
  #shop-modal {
    position: absolute; inset: 0; background: rgba(5, 5, 10, 0.98);
    z-index: 100; display: none; flex-direction: column; align-items: center;
    padding: 40px 20px;
    overflow-y: auto;
  }
  #shop-title {
    font-family: var(--font-impact); font-size: 50px; color: white;
    text-transform: uppercase; text-shadow: 3px 3px 0 #bd00ff; letter-spacing: 2px; margin-bottom: 10px;
  }
  #shop-currency {
    color: #ffd700; font-size: 20px; font-family: var(--font-mono);
    padding: 8px 25px; border: 1px solid #ffd700; border-radius: 20px;
    background: rgba(0,0,0,0.5); box-shadow: 0 0 10px rgba(255,215,0,0.2); margin-bottom: 40px;
  }
  #shop-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 25px; width: 100%; max-width: 900px; padding: 20px;
  }
  .shop-item {
    background: linear-gradient(135deg, #2a2a3a, #151520); border: 2px solid #333;
    display: flex; flex-direction: column; align-items: center; padding: 15px;
    cursor: pointer; position: relative; transform: skewX(-5deg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); border-bottom-width: 5px; transition: all 0.2s ease;
  }
  .shop-item:hover { transform: scale(1.05) skewX(-5deg); border-color: white; z-index: 2; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
  
  .shop-item[data-r="common"] { border-bottom-color: var(--r-common); }
  .shop-item[data-r="uncommon"] { border-bottom-color: var(--r-uncommon); }
  .shop-item[data-r="rare"] { border-bottom-color: var(--r-rare); }
  .shop-item[data-r="epic"] { border-bottom-color: var(--r-epic); }
  .shop-item[data-r="legendary"] { border-bottom-color: var(--r-legendary); }
  .shop-item[data-r="mythic"] { border-bottom-color: var(--r-mythic); box-shadow: 0 0 20px var(--r-mythic); }
  
  .shop-item.equipped { border-color: #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.6); }
  .shop-item.equipped::after {
    content: 'EQUIPPED'; position: absolute; top: -10px; background: #ffd700;
    color: black; font-weight: bold; font-size: 10px; padding: 2px 8px; transform: skewX(5deg);
  }
  .item-preview {
    width: 110px; height: 110px; background: rgba(0,0,0,0.3);
    margin-bottom: 15px; display: flex; justify-content: center; align-items: center; 
    border-radius: 4px;
    transform: skewX(5deg);
  }
  .item-preview canvas { width: 90px; height: 90px; image-rendering: pixelated; } 
  
  .item-name { color: white; font-weight: 800; font-size: 16px; margin-bottom: 5px; text-align: center; text-transform: uppercase; transform: skewX(5deg); }
  .shop-item[data-r="mythic"] .item-name { color: var(--r-mythic); }
  .item-price { color: #ffd700; font-size: 14px; font-family: var(--font-mono); font-weight: bold; transform: skewX(5deg); }

  #shop-close {
    margin-top: 40px; background: #b00; color: white; border: none;
    padding: 15px 60px; font-size: 24px; font-family: var(--font-impact);
    cursor: pointer; transform: skewX(-10deg); text-transform: uppercase; letter-spacing: 1px;
    transition: background 0.2s;
  }
  #shop-close:hover { background: #d00; }

  /* --- DEATH SCREEN --- */
  #death-screen {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    justify-content: center; align-items: center; background: rgba(0,0,0,0.60);
    opacity: 0; pointer-events: none; transition: opacity 0.8s ease-out;
    font-family: var(--font-display); z-index: 20;
  }
  #death-title {
    font-size: 80px; font-weight: 700; color: #8C0000;
    text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 10px rgba(0,0,0,0.8);
    letter-spacing: 15px; margin-bottom: 20px; text-align: center;
  }
  #death-sub { font-size: 24px; color: #e0d165; text-shadow: 0 1px 2px #000; letter-spacing: 2px; text-align: center; }

  /* --- MOBILE CONTROLS --- */
  #touch-btn {
    position: absolute; right: 20px; bottom: 20px; width: 75px; height: 75px;
    border-radius: 50%; background: #ffd42a; display: flex; align-items: center; justify-content: center;
    font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 15; font-size: 24px;
    user-select: none;
  }
  @media (min-width: 700px) { #touch-btn { display: none; } }
  @media (max-width: 600px) { #death-title { font-size: 50px; letter-spacing: 5px; } }
</style>
</head>

<body>
<canvas id="game"></canvas>

<div id="hud-container">
  <div id="hud-stats">
    <div id="hud-score">SCORE: 0</div>
    <div id="hud-stars">STARS: 0</div>
  </div>
  <canvas id="clock-canvas" width="64" height="64"></canvas>
</div>

<div id="overlay-center" class="ui-layer">Tap / Space to Start</div>

<div id="multiplier-container">
  <div id="multiplier-text">X2 STARS!</div>
  <div id="multiplier-timer"></div> 
</div>

<div id="shop-btn-wrap">
  <button id="shop-btn">
    <div class="star-icon">★</div> <span>ITEM SHOP</span> <div class="star-icon">★</div>
  </button>
</div>

<div id="shop-modal">
  <div id="shop-title">Item Shop</div>
  <div id="shop-currency">STARS: 0</div>
  <div id="shop-grid"></div>
  <button id="shop-close">Back To Game</button>
</div>

<div id="death-screen">
  <div id="death-title">YOU DIED</div>
  <div id="death-sub"></div> 
</div>

<div id="touch-btn">▲</div>

<script>
(() => {
  /** CONFIG & DATA */
  const PIXEL_DATA = {
    // ITEMS
    dunce: { colors: { 1:"#ecf0f1", 2:"#000" }, map: ["0001000","0001000","0011100","0012100","0111110","1111111"] },
    headband: { colors: { 1:"#c0392b", 2:"#fff" }, map: ["00000000","11111111","12121212","11111111","10000001","10000001"] },
    cap: { colors: { 1:"#e74c3c", 2:"#ffffff" }, map: ["0000011112222","0001111122222","0011111122222","0111111122222","1111111122222","1111111122222","1111111111111"] },
    cowboy: { colors: { 1:"#8d6e63", 2:"#5d4037" }, map: ["000111000","001111100","011121110","111222111","111111111","111111111"] },
    tophat: { colors: { 1:"#2c3e50", 2:"#c0392b", 3:"#34495e" }, map: ["0111110","0111110","0111110","0111110","0222220","1111111","3111113"] },
    propeller: { colors: { 1:"#3498db", 2:"#e74c3c", 3:"#f1c40f" }, map: ["00300","00300","11311","11211","00100"] },
    viking: { colors: { 1:"#95a5a6", 2:"#bdc3c7", 3:"#ecf0f1" }, map: ["0030003","03130313","311131113","112111211","111111111"] },
    devil: { colors: { 1:"#c0392b", 2:"#fff" }, map: ["10001","10001","11011","00000"] },
    crown: { colors: { 1:"#f1c40f", 2:"#e74c3c" }, map: ["10101","10101","10101","11211","11111"] },
    wizardMega: { colors: { 1:"#673ab7", 2:"#4527a0", 3:"#ffd700" }, map: ["00000000212000","00000000212000","0000002112000","00000021131200","00000021111200","00000211311200","00002111111200","00021311113120","00211111111120","02113333333120","21333333333312","11111111111111","13113111131131","11111111111111"] },
    
    // Multipliers
    "2": { colors: { 1: "#ffffff" }, map: ["111000101","001000101","111000010","100000101","111000101"] },
    "3": { colors: { 1: "#ffffff" }, map: ["111000101","001000101","111000010","001000101","111000101"] },
    "5": { colors: { 1: "#ffffff" }, map: ["111000101","100000101","111000010","001000101","111000101"] }
  };

  const SHOP_ITEMS = [
    { id: 'dunce', name: 'Dunce Cap', price: 0, rarity: 'common' },
    { id: 'headband', name: 'Karate Kid', price: 25, rarity: 'common' },
    { id: 'cap', name: 'Trucker Hat', price: 50, rarity: 'uncommon' },
    { id: 'cowboy', name: 'Sheriff', price: 100, rarity: 'uncommon' },
    { id: 'tophat', name: 'Gentleman', price: 150, rarity: 'rare' },
    { id: 'propeller', name: 'Propeller Hat', price: 250, rarity: 'rare' },
    { id: 'viking', name: 'Viking Helmet', price: 500, rarity: 'epic' },
    { id: 'devil', name: 'Lil\' Horns', price: 666, rarity: 'epic' },
    { id: 'crown', name: 'Victory Crown', price: 1000, rarity: 'legendary' },
    { id: 'wizardMega', name: 'Grand Magus', price: 1500, rarity: 'mythic' }
  ];

  const CONSTANTS = {
    PHYSICS: { GRAVITY: 1800, JUMP: -760, SPEED_START: 260, SPEED_MAX: 900, SPEED_INC: 8, SCORE_MULT: 0.15 },
    DIMS: { PLAYER: 36, PLAT_H: 24, STAR: 24, GROUND_OFF: 140, DEATH_Z: 100 },
    GEN: { 
        GAP: {MIN:80, MAX:400}, 
        WIDTH: {MIN:260, MAX:480}, 
        Y_VAR: {MIN:-50, MAX:90},
        STAR_C: 0.4, 
        GAP_STAR_C: 0.1, 
        MULT_C: 0.06, 
        CYCLE: 15000 // 15k Cycle
    },
    COLORS: { PLAT: "#5d4037", PLAT_TOP: "#4caf50", PLAYER: "#ffd42a", STAR: "#ffd700", BIRDS_C: ["#f0f8ff","#808080","#333333"], BIRDS_R: ["#aeea00","#ff0055","#00ccff"] }
  };

  /** UTILITIES */
  const Utils = {
    rand: (a, b) => Math.random() * (b - a) + a,
    randInt: (a, b) => Math.floor(Math.random() * (b - a + 1)) + a,
    clamp: (v, a, b) => Math.max(a, Math.min(b, v)),
    lerp: (a, b, t) => a + (b - a) * t,
    lerpColor: (a, b, amount) => {
      const ah = parseInt(a.slice(1), 16), bh = parseInt(b.slice(1), 16);
      const ar = ah>>16, ag = (ah>>8)&0xff, ab = ah&0xff, br = bh>>16, bg = (bh>>8)&0xff, bb = bh&0xff;
      return '#' + ((1<<24) + ((ar+(br-ar)*amount)<<16) + ((ag+(bg-ag)*amount)<<8) + (ab+(bb-ab)*amount|0)).toString(16).slice(1);
    },
    AABB: (r1, r2) => r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y
  };

  const StorageManager = {
    KEY: 'run4fun_save_v7',
    load: () => {
      try { return JSON.parse(localStorage.getItem(StorageManager.KEY)) || { totalStars: 0, unlocked: ['dunce'], equipped: null }; }
      catch { return { totalStars: 0, unlocked: ['dunce'], equipped: null }; }
    },
    save: (data) => localStorage.setItem(StorageManager.KEY, JSON.stringify(data))
  };

  /** GRAPHICS CACHE */
  const AssetFactory = {
    cache: {},
    init() {
      Object.keys(PIXEL_DATA).forEach(key => {
        this.cache[key] = this.createCanvas(PIXEL_DATA[key]);
      });
    },
    createCanvas(art) {
      const rows = art.map.length, cols = art.map[0].length;
      const cvs = document.createElement('canvas');
      cvs.width = cols; cvs.height = rows;
      const ctx = cvs.getContext('2d');
      for(let r=0; r<rows; r++) {
        for(let c=0; c<cols; c++) {
          if(art.map[r][c] !== '0') {
            ctx.fillStyle = art.colors[art.map[r][c]];
            ctx.fillRect(c, r, 1, 1);
          }
        }
      }
      return { img: cvs, w: cols, h: rows };
    },
    get(id) { return this.cache[id]; }
  };

  /** GAME CLASSES */
  class Player {
    constructor(groundY) {
      this.size = CONSTANTS.DIMS.PLAYER;
      this.x = 150;
      this.y = groundY - this.size;
      this.vy = 0;
      this.jumps = 2;
      this.alive = true;
    }
    update(dt, platforms, gravity) {
      if (!this.alive) return;
      this.vy += gravity * dt;
      this.y += this.vy * dt;
      const b = this.y + this.size, r = this.x + this.size;
      
      for (const p of platforms) {
        if (r > p.x && this.x < p.x + p.w) {
          const prevY = b - (this.vy * dt);
          if (prevY <= p.y + 5 && b >= p.y && this.vy >= 0) {
            this.y = p.y - this.size;
            this.vy = 0;
            this.jumps = 2;
          }
        }
      }
    }
    jump() {
      if (this.jumps > 0) { this.vy = CONSTANTS.PHYSICS.JUMP; this.jumps--; }
    }
  }

  class DayNightCycle {
    constructor() {
      // Cycle starts at NOON (p=0.0)
      this.sky = [
        {p:0.0, t:"#004e92", b:"#4ca1af"}, // Noon
        {p:0.35, t:"#004e92", b:"#4ca1af"}, // Afternoon
        {p:0.45, t:"#ff6b00", b:"#ffb457"}, // Sunset
        {p:0.55, t:"#000033", b:"#1e3a8a"}, // Night Start
        {p:0.85, t:"#000033", b:"#1e3a8a"}, // Night End
        {p:0.95, t:"#ffcc80", b:"#ff9068"}, // Sunrise
        {p:1.0, t:"#004e92", b:"#4ca1af"}   // Noon
      ];
      this.mtn = [
        {p:0.0, f:"#2c3e50", n:"#34495e", h:"#455a64"},
        {p:0.45, f:"#5a3a2a", n:"#6d4e3e", h:"#806653"},
        {p:0.55, f:"#1a1a2e", n:"#282a4a", h:"#3e4064"},
        {p:0.85, f:"#1a1a2e", n:"#282a4a", h:"#3e4064"},
        {p:0.95, f:"#5a3a2a", n:"#6d4e3e", h:"#806653"},
        {p:1.0, f:"#2c3e50", n:"#34495e", h:"#455a64"}
      ];
    }
    get(score) {
      const p = (score % CONSTANTS.GEN.CYCLE) / CONSTANTS.GEN.CYCLE;
      const solve = (arr) => {
        let i = 0; while(i<arr.length-1 && p > arr[i+1].p) i++;
        const t = (p - arr[i].p) / (arr[Math.min(arr.length-1, i+1)].p - arr[i].p);
        return { s: arr[i], e: arr[Math.min(arr.length-1, i+1)], t };
      };
      const s = solve(this.sky), m = solve(this.mtn);
      return {
        skyTop: Utils.lerpColor(s.s.t, s.e.t, s.t), skyBot: Utils.lerpColor(s.s.b, s.e.b, s.t),
        far: Utils.lerpColor(m.s.f, m.e.f, m.t), near: Utils.lerpColor(m.s.n, m.e.n, m.t), hills: Utils.lerpColor(m.s.h, m.e.h, m.t),
        p
      };
    }
  }

  class Game {
    constructor() {
      this.cvs = document.getElementById("game");
      this.ctx = this.cvs.getContext("2d", { alpha: false });
      this.ui = {
        score: document.getElementById("hud-score"), stars: document.getElementById("hud-stars"),
        clock: document.getElementById("clock-canvas"),
        overlay: document.getElementById("overlay-center"), death: document.getElementById("death-screen"), deathSub: document.getElementById("death-sub"),
        shop: document.getElementById("shop-modal"), shopGrid: document.getElementById("shop-grid"), shopStars: document.getElementById("shop-currency"),
        mult: document.getElementById("multiplier-container"), multTxt: document.getElementById("multiplier-text"), multTime: document.getElementById("multiplier-timer"),
        shopBtn: document.getElementById("shop-btn-wrap"), closeShop: document.getElementById("shop-close"), touch: document.getElementById("touch-btn")
      };
      this.clockCtx = this.ui.clock.getContext("2d");
      
      this.cycle = new DayNightCycle();
      this.data = StorageManager.load();
      AssetFactory.init();

      this.loop = this.loop.bind(this);
      window.addEventListener("resize", () => this.resize());
      
      const input = (e) => {
        if(this.shopOpen) return;
        if(e.type === 'keydown' && (e.code!=="Space" && e.code!=="KeyW")) return;
        if(e.preventDefault) e.preventDefault(); 
        this.handleInput();
      };
      window.addEventListener("keydown", input);
      window.addEventListener("pointerdown", (e) => {
        if(e.target.closest('#shop-modal') || e.target.closest('#shop-btn-wrap')) return;
        input(e);
      });
      this.ui.shopBtn.addEventListener("click", () => this.toggleShop(true));
      this.ui.closeShop.addEventListener("click", () => this.toggleShop(false));

      this.resize();
      this.reset();
      this.updateShop();
      requestAnimationFrame(this.loop);
    }

    handleInput() {
      if (!this.player.alive) { this.reset(); return; }
      if (this.startDelay) {
        this.startDelay = false;
        this.ui.overlay.style.opacity = 0;
        this.ui.shopBtn.style.display = "none";
        this.player.jumps = 2;
        return;
      }
      this.player.jump();
    }

    toggleShop(open) {
      this.shopOpen = open;
      this.ui.shop.style.display = open ? 'flex' : 'none';
      this.ui.shopBtn.style.display = open ? 'none' : 'block';
      this.ui.mult.style.display = open ? 'none' : 'flex';
      if(open) this.updateShop();
    }

    updateShop() {
      this.ui.shopStars.innerText = "STARS: " + this.data.totalStars;
      this.ui.shopGrid.innerHTML = '';
      SHOP_ITEMS.forEach(item => {
        const owned = this.data.unlocked.includes(item.id);
        const equipped = this.data.equipped === item.id;
        const el = document.createElement('div');
        el.className = `shop-item ${equipped ? 'equipped' : ''}`;
        el.dataset.r = item.rarity;
        
        const c = document.createElement('canvas'); 
        const art = AssetFactory.get(item.id);
        const scale = art.h > 10 ? 5 : 7;
        c.width=90; c.height=90; 
        
        const ctx = c.getContext('2d'); 
        ctx.imageSmoothingEnabled = false;
        
        const drawW = art.w * scale;
        const drawH = art.h * scale;
        ctx.drawImage(art.img, (90-drawW)/2, (90-drawH)/2, drawW, drawH);

        el.innerHTML = `<div class="item-preview"></div><div class="item-name">${item.name}</div><div class="item-price">${owned ? (equipped?'EQUIPPED':'OWNED') : item.price+' Stars'}</div>`;
        el.firstChild.appendChild(c);
        
        el.onclick = () => {
           if(owned) {
             this.data.equipped = (this.data.equipped === item.id) ? null : item.id;
             StorageManager.save(this.data);
           } else if(this.data.totalStars >= item.price) {
             this.data.totalStars -= item.price;
             this.data.unlocked.push(item.id);
             this.data.equipped = item.id;
             StorageManager.save(this.data);
           } else {
             const p = el.querySelector('.item-price');
             const old = p.innerText; p.innerText = "NEED MORE STARS!"; p.style.color="#f00";
             setTimeout(()=>{ p.innerText=old; p.style.color="#ffd700"; }, 1000);
           }
           this.updateShop();
        };
        this.ui.shopGrid.appendChild(el);
      });
    }

    resize() {
      this.dpr = window.devicePixelRatio || 1;
      this.cvs.width = window.innerWidth * this.dpr;
      this.cvs.height = window.innerHeight * this.dpr;
      this.ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);
      this.ctx.imageSmoothingEnabled = false;
      this.w = this.cvs.width / this.dpr;
      this.h = this.cvs.height / this.dpr;
      if(this.player) this.player.y = Math.min(this.player.y, this.groundY - 50);
    }

    get groundY() { return this.h - CONSTANTS.DIMS.GROUND_OFF; }

    reset() {
      this.player = new Player(this.groundY);
      this.speed = CONSTANTS.PHYSICS.SPEED_START;
      this.score = 0;
      this.runStars = 0;
      this.startDelay = true;
      this.time = 0;
      this.lastT = performance.now();
      
      this.objs = { plats: [], stars: [], mults: [], parts: [], birds: [], clouds: [], mtn: { f:[], n:[], h:[] } };
      this.activeMult = { val: 1, time: 0 };
      this.bgStars = []; 
      for(let i=0; i<35; i++) this.bgStars.push({x:Math.random(), y:Math.random(), s:Math.random()*2+1, a:Math.random()});
      this.shootStar = null;

      this.ui.score.innerText = "SCORE: 0";
      this.ui.stars.innerText = "STARS: " + this.data.totalStars;
      this.ui.overlay.style.opacity = 1;
      this.ui.death.style.opacity = 0;
      this.ui.death.style.pointerEvents = "none";
      this.ui.shopBtn.style.display = "block";
      this.ui.mult.className = "";
      this.ui.multTime.innerText = "";

      this.initWorld();
    }

    initWorld() {
      const H = this.h;
      const layer = (arr, w, min, max, s, type) => {
        let x = 0, y = Utils.rand(min, max);
        while(x < this.w + w) {
          let segs = (type === 'far') ? 8 : 4;
          let segW = w / segs;
          let pts = [{x:0,y}];
          let cy = y;
          for(let i=1; i<=segs; i++) {
            cy = Utils.clamp(cy + Utils.rand(type==='hills'?-50:-100, type==='hills'?50:100), min, max);
            if(type === 'near') cy = Utils.clamp(cy + Utils.rand(-40,40), min, max); 
            pts.push({x:i*segW, y:cy});
          }
          arr.push({x, w, pts, s});
          x += w; y = cy;
        }
      };
      layer(this.objs.mtn.f, 800, H-650, H-400, 0.15, 'far');
      layer(this.objs.mtn.n, 700, H-450, H-250, 0.3, 'near');
      layer(this.objs.mtn.h, 450, H-180, H-100, 0.6, 'hills');
      
      // Voxel Clouds
      for(let i=0; i<8; i++) {
          let cx = Utils.rand(0, this.w);
          let parts = [];
          let w = Utils.rand(80, 120);
          let h = Utils.rand(30, 50);
          parts.push({x:0, y:0, w:w, h:h}); // Main body
          parts.push({x:Utils.rand(10, w-40), y:-Utils.rand(10, 20), w:Utils.rand(30, 50), h:20}); // Top detail
          this.objs.clouds.push({x:cx, y:Utils.rand(20,H*0.4), parts, s:Utils.rand(10,25), a:Utils.rand(0.5,0.9)});
      }
      for(let i=0; i<3; i++) this.spawnBird();
      
      let cx = this.player.x - 60;
      this.objs.plats.push({x:cx, y:this.groundY, w:500, h:CONSTANTS.DIMS.PLAT_H});
      cx += 560;
      for(let i=0; i<6; i++) cx = this.addPlatform(cx, i);
    }

    checkOverlap(x, y, margin=40) {
        for(let s of this.objs.stars) {
            if(Math.abs(s.x - x) < margin && Math.abs(s.y - y) < margin) return true;
        }
        for(let m of this.objs.mults) {
            if(Math.abs(m.x - x) < margin && Math.abs(m.y - y) < margin) return true;
        }
        return false;
    }

    addPlatform(sx, idx) {
      const gap = Utils.rand(CONSTANTS.GEN.GAP.MIN, CONSTANTS.GEN.GAP.MAX);
      const w = Utils.rand(CONSTANTS.GEN.WIDTH.MIN, CONSTANTS.GEN.WIDTH.MAX);
      const ly = this.objs.plats.length ? this.objs.plats[this.objs.plats.length-1].y : this.groundY;
      const y = Utils.clamp(ly + Utils.rand(CONSTANTS.GEN.Y_VAR.MIN, CONSTANTS.GEN.Y_VAR.MAX), 70, this.h - 80);
      const p = { x: sx + gap, y, w, h: CONSTANTS.DIMS.PLAT_H };
      this.objs.plats.push(p);

      const tryMult = (this.activeMult.time <= 0) && (Math.random() < CONSTANTS.GEN.MULT_C);
      
      if (tryMult) {
        const r = Math.random(), val = r<0.1 ? 5 : (r<0.3 ? 3 : 2);
        const mx = p.x + p.w/2, my = p.y-25;
        if (!this.checkOverlap(mx, my)) {
            this.objs.mults.push({ x: mx, y: my, val, dur: Utils.rand(5,10) });
        }
      } else if (this.activeMult.time > 0) {
        const count = this.activeMult.val, spac = CONSTANTS.DIMS.STAR*2, tw = count*spac;
        if (p.w - tw > 0) {
          const start = p.x + Utils.rand(20, p.w - tw - 20);
          for(let i=0; i<count; i++) {
              const sx = start + i*spac + CONSTANTS.DIMS.STAR/2, sy = p.y - 22;
              if(!this.checkOverlap(sx, sy)) this.spawnStar(sx, sy);
          }
        }
      }

      if (!tryMult && Math.random() < CONSTANTS.GEN.STAR_C) {
        const sx = p.x + p.w/2, sy = p.y - 22;
        if(!this.checkOverlap(sx, sy)) this.spawnStar(sx, sy);
      }

      if (idx > 0 && Math.random() < CONSTANTS.GEN.GAP_STAR_C) {
        let prev = this.objs.plats[this.objs.plats.length-2];
        const sx = prev.x + prev.w + gap/2;
        const sy = Utils.clamp((prev.y+p.y)/2 - 80, this.h*0.1, this.h-200);
        if(!this.checkOverlap(sx, sy)) this.spawnStar(sx, sy);
      }
      return p.x + p.w;
    }

    spawnStar(x, y) { 
        this.objs.stars.push({ x, y, s:CONSTANTS.DIMS.STAR, r:Utils.rand(0,6), col:false, anim:0, val: this.activeMult.time > 0 ? this.activeMult.val : 1 }); 
    }
    
    spawnBird() {
      const rare = Math.random()<0.05, pool = rare ? CONSTANTS.COLORS.BIRDS_R : CONSTANTS.COLORS.BIRDS_C;
      this.objs.birds.push({ x:this.w+Utils.rand(50,350), y:Utils.rand(this.h*0.35,this.h*0.55), s:Utils.rand(90,140), flap:0, c:pool[Math.floor(Math.random()*pool.length)] });
    }

    update(dt) {
      if(!this.player.alive) return;
      
      if(!this.shootStar && Math.random() < 0.00025) {
          this.shootStar = { x:Utils.rand(0,this.w), y:Utils.rand(0,this.h/3), vx:Utils.rand(400,800), vy:Utils.rand(100,200), l:1.5 };
      }
      if(this.shootStar) {
          this.shootStar.x += this.shootStar.vx*dt;
          this.shootStar.y += this.shootStar.vy*dt;
          this.shootStar.l -= dt;
          if(this.shootStar.l <= 0) this.shootStar = null;
      }

      if(this.activeMult.time > 0) {
        this.activeMult.time -= dt;
        this.ui.multTime.innerText = Math.max(0, Math.ceil(this.activeMult.time));
        if(this.activeMult.time <= 0) {
           this.activeMult.val = 1;
           this.ui.mult.className = "";
           this.ui.multTime.innerText = "";
           this.objs.stars.forEach(s => s.val = 1);
        }
      }

      if (!this.startDelay) {
        this.speed = Math.min(CONSTANTS.PHYSICS.SPEED_MAX, this.speed + dt * CONSTANTS.PHYSICS.SPEED_INC);
        this.score += (this.speed * dt) * CONSTANTS.PHYSICS.SCORE_MULT;
        this.ui.score.innerText = "SCORE: " + Math.floor(this.score);
      }

      const scroll = this.startDelay ? 0 : this.speed * dt;

      const updL = (list, spd, min, max, type) => {
        for(let m of list) m.x -= this.speed * m.s * dt;
        list = list.filter(m => m.x + m.w > 0);
        const last = list[list.length-1];
        if(last.x + last.w < this.w + 800*0.25) {
           let segs = (type === 'far') ? 8 : 4;
           let y = last.pts[last.pts.length-1].y;
           let segW = last.w / segs;
           let pts = [{x:0,y}];
           let cy = y;
           for(let i=1; i<=segs; i++){
             cy = Utils.clamp(cy + Utils.rand(type==='hills'?-50:-100, type==='hills'?50:100), min, max);
             if(type==='near') cy = Utils.clamp(cy + Utils.rand(-40,40), min, max);
             pts.push({x:i*segW, y:cy});
           }
           list.push({x:last.x+last.w-4, w:last.w, pts, s:spd});
        }
        return list;
      };
      this.objs.mtn.f = updL(this.objs.mtn.f, 0.15, this.h-650, this.h-400, 'far');
      this.objs.mtn.n = updL(this.objs.mtn.n, 0.3, this.h-450, this.h-250, 'near');
      this.objs.mtn.h = updL(this.objs.mtn.h, 0.6, this.h-180, this.h-100, 'hills');

      this.objs.clouds.forEach(c => { c.x -= (this.startDelay?0:this.speed*0.12 + c.s*0.02)*dt; if(c.x+200<-100) c.x=this.w+100; });
      this.objs.birds.forEach(b => { b.x -= b.s*dt; b.flap += dt * 5; });
      this.objs.birds = this.objs.birds.filter(b => b.x > -200);
      if(this.objs.birds.length < 4) this.spawnBird();

      this.objs.plats.forEach(p => p.x -= scroll);
      this.objs.plats = this.objs.plats.filter(p => p.x + p.w > -300);
      let right = -999; this.objs.plats.forEach(p => right = Math.max(right, p.x+p.w));
      while(right < this.w + 600) right = this.addPlatform(right, this.objs.plats.length);

      const pBox = {x:this.player.x, y:this.player.y, w:this.player.size, h:this.player.size};

      this.objs.mults.forEach(m => {
        m.x -= scroll;
        if(!m.col && Utils.AABB(pBox, {x:m.x-14,y:m.y-14,w:28,h:28})) {
          m.col = true;
          this.activeMult = { val:m.val, time:m.dur };
          this.ui.multTxt.innerText = `X${m.val} STAR BONUS!`;
          this.ui.multTime.innerText = m.dur;
          this.ui.mult.className = "active";
          this.objs.mults.forEach(o => o.col = true);
          
          const extras = this.activeMult.val - 1;
          const visibleStars = [...this.objs.stars];
          visibleStars.forEach(s => {
              if(s.col) return;
              for(let i=1; i<=extras; i++) {
                  const offset = (Math.ceil(i/2) * 30) * (i%2===0 ? 1 : -1);
                  this.spawnStar(s.x + offset, s.y);
              }
          });
        }
      });
      this.objs.mults = this.objs.mults.filter(m => m.x > -100 && !m.col);

      this.objs.stars.forEach(s => {
        s.x -= scroll;
        if(s.col) {
          s.anim += dt;
          s.y -= (600*dt) - (600 * s.anim * dt); 
          s.r += dt*20;
        } else {
          s.r += dt*3;
          if(Utils.AABB(pBox, {x:s.x-s.s/2,y:s.y-s.s/2,w:s.s,h:s.s})) {
            this.runStars += s.val; 
            this.ui.stars.innerText = "STARS: " + (this.data.totalStars + this.runStars);
            s.col = true;
            for(let i=0; i<8; i++) this.objs.parts.push({x:s.x, y:s.y, vx:Utils.rand(-150,150), vy:Utils.rand(-250,-50), l:0.6, c:CONSTANTS.COLORS.STAR});
          }
        }
      });
      this.objs.stars = this.objs.stars.filter(s => s.anim < 0.6);

      this.objs.parts.forEach(p => { p.x+=p.vx*dt; p.y+=p.vy*dt; p.l-=dt; });
      this.objs.parts = this.objs.parts.filter(p => p.l > 0);

      if(!this.startDelay) this.player.update(dt, this.objs.plats, CONSTANTS.PHYSICS.GRAVITY);
      
      if(this.player.y > this.h + CONSTANTS.DIMS.DEATH_Z) {
        this.player.alive = false;
        this.data.totalStars += this.runStars;
        StorageManager.save(this.data);
        this.ui.death.style.opacity = 1;
        this.ui.death.style.pointerEvents = "auto";
        this.ui.deathSub.innerText = "Tap/Space to Restart";
        this.ui.shopBtn.style.display = "block";
        this.ui.mult.className = "";
        this.ui.multTime.innerText = "";
      }
    }

    drawClock(p) {
        const ctx = this.clockCtx;
        const w = 64, h = 64;
        ctx.clearRect(0,0,w,h);
        
        const col = this.cycle.get(this.score);
        ctx.fillStyle = col.skyTop; 
        ctx.fillRect(0,0,w,h);

        const cx = w/2, cy = h/2;
        const radius = 22;
        const angle = p * Math.PI * 2;
        
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);

        // Sun
        ctx.fillStyle = "#FFD700";
        ctx.shadowBlur = 10; ctx.shadowColor = "#FFD700";
        ctx.beginPath(); ctx.arc(0, -radius, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;

        // Moon
        ctx.fillStyle = "#EEE";
        ctx.beginPath(); ctx.arc(0, radius, 5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#CCC";
        ctx.beginPath(); ctx.arc(-1, radius-1, 1.5, 0, Math.PI*2); ctx.fill();

        ctx.restore();
        
        // Clock face border
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(cx, cy, 30, 0, Math.PI*2); ctx.stroke();
    }

    draw() {
      const ctx = this.ctx, W = this.w, H = this.h;
      const col = this.cycle.get(this.score);
      
      this.drawClock(col.p);

      const grad = ctx.createLinearGradient(0,0,0,H);
      grad.addColorStop(0, col.skyTop); grad.addColorStop(0.5, col.skyBot); grad.addColorStop(1, Utils.lerpColor(col.skyBot, "#ffffff", 0.5));
      ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);

      // Stars
      let starAlpha = 0;
      if (col.p > 0.4 && col.p < 0.9) {
          starAlpha = 1;
          if(col.p < 0.55) starAlpha = (col.p - 0.4) * 6.6; // fade in sunset
          if(col.p > 0.85) starAlpha = (0.9 - col.p) * 20; // fade out dawn
      }

      if(starAlpha > 0) {
          ctx.fillStyle = "white";
          this.bgStars.forEach(s => {
              ctx.globalAlpha = s.a * starAlpha;
              ctx.fillRect(s.x*W, s.y*H*0.6, s.s, s.s);
          });
          ctx.globalAlpha = 1;
      }

      if(this.shootStar && starAlpha > 0.5) {
          ctx.strokeStyle = "white";
          ctx.lineWidth = 2;
          ctx.globalAlpha = Math.min(1, this.shootStar.l);
          ctx.beginPath();
          ctx.moveTo(this.shootStar.x, this.shootStar.y);
          ctx.lineTo(this.shootStar.x - this.shootStar.vx*0.1, this.shootStar.y - this.shootStar.vy*0.1);
          ctx.stroke();
          ctx.globalAlpha = 1;
      }

      const ca = Utils.lerp(1, 0.2, col.p>0.5?(col.p-0.5)*2:0);
      this.objs.clouds.forEach(c => { 
        ctx.globalAlpha = c.a*ca; 
        ctx.fillStyle = "white";
        c.parts.forEach(p => ctx.fillRect(c.x+p.x, c.y+p.y, p.w, p.h));
      });
      ctx.globalAlpha = 1;

      const drawMtn = (l, c, isFar) => {
        l.forEach(m => {
          const rx = Math.round(m.x);
          ctx.fillStyle = c; ctx.beginPath(); 
          ctx.moveTo(rx, H);
          m.pts.forEach(pt => ctx.lineTo(rx+pt.x, pt.y));
          ctx.lineTo(rx+m.w, H);
          ctx.fill();

          if(isFar) {
            m.pts.forEach((pt, i) => {
               if(pt.y < H * 0.45) {
                  const prev = m.pts[i-1] || pt, next = m.pts[i+1] || pt;
                  const leftSlopeX = (prev.x - pt.x);
                  const leftSlopeY = (prev.y - pt.y);
                  const rightSlopeX = (next.x - pt.x);
                  const rightSlopeY = (next.y - pt.y);
                  
                  ctx.fillStyle = "#fff";
                  ctx.beginPath();
                  ctx.moveTo(rx+pt.x, pt.y); // Peak
                  ctx.lineTo(rx+pt.x + rightSlopeX*0.4, pt.y + rightSlopeY*0.4);
                  ctx.lineTo(rx+pt.x + leftSlopeX*0.4, pt.y + leftSlopeY*0.4);
                  ctx.closePath();
                  ctx.fill();
               }
            });
          }
        });
      };
      drawMtn(this.objs.mtn.f, col.far, true);
      drawMtn(this.objs.mtn.n, col.near, false);

      this.objs.birds.forEach(b => {
        ctx.save(); ctx.translate(b.x, b.y);
        const frame = Math.floor(b.flap) % 2;
        ctx.fillStyle=b.c; ctx.fillRect(0,0,12,8); ctx.fillRect(12,-4,8,8);
        ctx.fillStyle="#ff9800"; ctx.fillRect(20,-4,4,4);
        ctx.fillStyle=b.c; ctx.globalAlpha=0.85; ctx.fillRect(4, frame===0?-8:4, 8, 8);
        ctx.restore();
      });

      drawMtn(this.objs.mtn.h, col.hills, false);

      ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.lineWidth = 2;
      this.objs.plats.forEach(p => {
        ctx.fillStyle=CONSTANTS.COLORS.PLAT; ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle=CONSTANTS.COLORS.PLAT_TOP; ctx.fillRect(p.x, p.y, p.w, 6);
        ctx.strokeRect(p.x, p.y, p.w, p.h);
      });

      this.objs.mults.forEach(m => {
        const art = AssetFactory.get(m.val.toString());
        if(art) {
           const y = m.y + Math.sin(this.time*4)*5;
           const scale = 4;
           const dw = art.w * scale, dh = art.h * scale;
           ctx.drawImage(art.img, m.x-dw/2, y-dh/2, dw, dh); 
        }
      });

      ctx.fillStyle = CONSTANTS.COLORS.STAR; ctx.shadowColor = CONSTANTS.COLORS.STAR; ctx.lineJoin = "round"; ctx.lineWidth = 4;
      this.objs.stars.forEach(s => {
        ctx.save(); ctx.translate(s.x, s.y); ctx.rotate(s.r);
        if(s.col) ctx.globalAlpha = Math.max(0, 1-(s.anim/0.5));
        ctx.shadowBlur = s.col ? 0 : 10;
        const sz = s.s + (s.col ? 0 : Math.sin(this.time*5)*2);
        ctx.beginPath();
        for(let i=0, rot=Math.PI/2*3; i<5; i++) {
          ctx.lineTo(Math.cos(rot)*sz/2, Math.sin(rot)*sz/2); rot+=Math.PI/5;
          ctx.lineTo(Math.cos(rot)*sz/4, Math.sin(rot)*sz/4); rot+=Math.PI/5;
        }
        ctx.closePath(); ctx.fill(); ctx.restore();
      });
      ctx.shadowBlur = 0; ctx.globalAlpha = 1;

      this.objs.parts.forEach(p => { ctx.fillStyle = p.c; ctx.globalAlpha = p.l/0.6; ctx.fillRect(p.x, p.y, 4, 4); });
      ctx.globalAlpha = 1;

      const pl = this.player;
      ctx.fillStyle = CONSTANTS.COLORS.PLAYER; ctx.fillRect(pl.x, pl.y, pl.size, pl.size);
      ctx.shadowColor = "#e6ac00"; ctx.shadowBlur = 10; ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 2;
      ctx.strokeRect(pl.x, pl.y, pl.size, pl.size); ctx.shadowBlur = 0;

      if (this.data.equipped) {
        const art = AssetFactory.get(this.data.equipped);
        if (art) {
          const scale = art.h > 10 ? 3 : 4;
          ctx.drawImage(art.img, pl.x + pl.size/2 - (art.w*scale)/2, pl.y - art.h*scale, art.w*scale, art.h*scale);
        }
      }
    }

    loop(now) {
      const dt = Math.min(0.05, (now - this.lastT) / 1000);
      this.lastT = now;
      if (!this.shopOpen) { this.time += dt; this.update(dt); }
      this.draw();
      requestAnimationFrame(this.loop);
    }
  }
  new Game();
})();
</script>
</body>
</html>
